<!doctype html>
<html lang="en">

<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109503004-1"></script>
    <script src="./NoSleep.min.js"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-109503004-1');
    </script>
    <meta charset="utf-8">
    <title>&#x1F550; timer.watch - a simple timer countdown</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A very simple and cute countdown timer">
    <meta name="theme-color" content="#66bf13">
    <meta name="author" content="Karl Adler">
    <link rel="manifest" href="manifest.json">
    <!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
    <![endif]-->
</head>
<style>
    * {
        margin: 0;
        padding: 0;
    }

    body {
        height: 100vh;
        display: flex;
        justify-content: center;
    }

    .centered {
        position: absolute;
        text-align: center;
        display: flex;
        justify-content: center;
        align-self: center;
    }

    .huge {
        font-size: 18vmin;
        font-family: "Courier New", Courier, monospace;
    }

    .small, .small a {
        font-size: 0.5em;
        color: #efefef;
    }

    .bottom {
        position: absolute;
        bottom: 1px;
    }

    .wrapper {
        height: 100vmin;
        width: 100vmin;
        overflow: hidden;
    }

    .circle-chart {
        width: 95vmin;
        height: 95vmin;
        margin: 2.5vmin;
    }

    .circle-chart__circle {
        transition: stroke-dasharray .1s linear;
        transform: rotate(-90deg);
        transform-origin: center;
    }

    .digits {
        cursor: pointer;
    }
</style>

<body>
    <div class="centered wrapper">
        <svg class="circle-chart" viewbox="0 0 100 100" width="100" height="100" xmlns="http://www.w3.org/2000/svg">
            <circle class="circle-chart__background" stroke="#efefef" stroke-width="2" fill="none" cx="50" cy="50"
                r="48" />
            <circle class="circle-chart__circle" id="progress-circle" stroke="#66bf13" stroke-width="2" stroke-linecap="round"
                fill="none" cx="50" cy="50" r="48" stroke-dasharray="0,300" />
        </svg>
        <span id="timer" class="centered digits huge" onClick="toggle()"></span>

        <noscript>please enable javascript to start the timer</noscript>
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
        .then(function(registration) {
            console.log('Registration successful, scope is:', registration.scope);
        })
        .catch(function(error) {
            console.log('Service worker registration failed, error:', error);
        });
        }

        var dayFactor = 1000 * 60 * 60 * 24;
        var hoursFactor = 1000 * 60 * 60;
        var minutesFactor = 1000 * 60;
        var secondsFactor = 1000;

        var left;
        var duration;
        var countDownDate;
        var start;

        var clocks = ['🕐','🕑','🕒','🕓','🕔','🕕','🕖','🕗','🕘','🕙','🕚','🕛'].reverse();

        var noSleep = new NoSleep();

        function enableNoSleep() {
            noSleep.enable();
            document.removeEventListener('click', enableNoSleep, false);
        }

        document.addEventListener('click', enableNoSleep, false);

        reset();
        go();

        function reset() {
            // TODO: proper reset  + UI
            var url = new URL(location.href);
            var d = parseInt(url.searchParams.get('d') || 0, 10) * dayFactor;
            var h = parseInt(url.searchParams.get('h') || 0, 10) * hoursFactor;
            var m = (parseInt(url.searchParams.get('m') || 0, 10) * minutesFactor);
            var s = parseInt(url.searchParams.get('s') || 0, 10) * secondsFactor;

            duration = (d + h + m + s);
            if (duration === 0) {
                duration = 15 * minutesFactor;
            }
            left = duration;
        }

        function toggle() {
            if (!timer) {
                countDownDate = new Date().getTime() + left;
                timer = setInterval(iteration, 100);
            } else {
                var now = new Date().getTime();
                left = countDownDate - now; // set new duration by distance

                clearInterval(timer);
                timer = false;
            }
        }

        function go() {
            start = new Date().getTime();
            countDownDate = start + duration;
            timer = setInterval(iteration, 100);
        }

        var counter = 0;
        function iteration() {
            var now = new Date().getTime();
            var distance = countDownDate - now;
            var progress = ((duration - (distance-1000)) / duration) * 100;
            var days = Math.floor(distance / dayFactor);
            var hours = Math.floor((distance % dayFactor) / hoursFactor);
            var minutes = Math.floor((distance % hoursFactor) / minutesFactor);
            var seconds = Math.floor((distance % minutesFactor) / secondsFactor);

            var daysOut = days > 0 ? days + ' days &shy;' : '';
            var hoursOut = ('00' + hours).substr(-2, 2) + ':';
            var minutesOut = ('00' + minutes).substr(-2, 2) + ':';
            var secondsOut = ('00' + seconds).substr(-2, 2);

            document.getElementById('timer').innerHTML = daysOut + hoursOut + minutesOut + secondsOut;

            if (minutes < 1) {
                document.title = secondsOut + ' s';
            } else {
               document.title = clocks[seconds % 12];
            }

            document.getElementById('progress-circle').setAttribute('stroke-dasharray', progress * 3 + ',300');

            if (distance < 0) {
                clearInterval(timer);
                document.getElementById('timer').innerHTML = 'finished';
                document.title = 'finished';
            }
        }
    </script>
</body>

</html>
